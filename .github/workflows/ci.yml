name: CI

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  python-sanity:
    name: Python Sanity
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Compile Python services
        run: |
          python -m compileall \
            services/api-producer/app \
            services/validator-consumer/app \
            services/analytics-consumer/app \
            services/external-payment-simulator/app

  java-tests:
    name: Java Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/persistent-consumer-java
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: maven

      - name: Run Maven tests
        run: mvn -B -ntp test

  compose-smoke:
    name: Docker Compose Smoke
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Start infrastructure
        working-directory: infra
        run: |
          docker compose config >/dev/null
          docker compose up -d kafka postgres prometheus grafana
          docker compose ps

      - name: Create and verify topics
        run: |
          chmod +x kafka/create-topics.sh
          ./kafka/create-topics.sh
          docker exec kafka kafka-topics --bootstrap-server localhost:9092 --list | grep events.raw.v1
          docker exec kafka kafka-topics --bootstrap-server localhost:9092 --list | grep events.validated.v1
          docker exec kafka kafka-topics --bootstrap-server localhost:9092 --list | grep events.dlq.v1

      - name: Tear down infrastructure
        if: always()
        working-directory: infra
        run: docker compose down -v --remove-orphans

  e2e-flow:
    name: End-to-End Flow
    runs-on: ubuntu-latest
    needs:
      - python-sanity
      - java-tests
      - compose-smoke
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: maven

      - name: Run end-to-end pipeline test
        run: bash scripts/ci-e2e.sh
